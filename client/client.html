<!DOCTYPE html>
<html>
  <head>
    <title>Advertisement Page</title>
  </head>
  <body>
    <p>Hi, This is a page for advertisement</p>

    <!-- Image element to display the received URL -->
    <img id="ad-image" />

    <!-- Impression Pixel -->
    <img id="impression-pixel" />

    <script>
      const socket = new WebSocket("ws://localhost:8081");

      socket.addEventListener("open", (event) => {
        console.log("WebSocket connection established!");
      });

      window.addEventListener("load", async () => {
        let adImage = document.getElementById("ad-image");

        // When the socket receives a message from the server
        socket.addEventListener("message", (event) => {
          const { id, url } = JSON.parse(event.data);
          adImage.src = url;

          // To check whether advertisement is turned on
          let rect = adImage.getBoundingClientRect();
          let isVisible =
            rect.bottom - rect.top > 0 && rect.right - rect.left > 0;

          // If AD is turned on, fire impression pixel
          if (isVisible) {
            let impressionPixel = document.getElementById("impression-pixel");
            impressionPixel.src = `http://update:8082/firePixel/${id}`;
          }
        });
      });
    </script>
  </body>
</html>
